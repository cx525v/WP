using CIS.WebApi.UnitTests.Common;
using Microsoft.Extensions.Caching.Distributed;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Localization;
using Microsoft.Extensions.Options;
using NSubstitute;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Worldpay.Logging.Providers.Log4Net.Facade;
using Wp.CIS.LynkSystems.Interfaces;
using Wp.CIS.LynkSystems.Model;
using Wp.CIS.LynkSystems.Services;
using Wp.CIS.LynkSystems.WebApi.Common;
using Wp.CIS.LynkSystems.WebApi.Controllers;
using Xunit;

namespace CIS.WebApi.UnitTests.EpsTable
{
    public class TestEPSTableApiController
    {
        [Fact]
        public async Task GetAllPetroTablesByVersionTest_Success()
        {
            int versionId = 1;
            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            ILoggingFacade fakeLogger = FakeLogger();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);
            var localizer = new MockStringLocalizer<EPSTableController>();
            EPSTableController controller = FakeController(_cache, epsTableApi,localizer);

            //.. Act

            var dinfo = await controller.GetAllPetroTablesByVersion(versionId);
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo).Value;

            //..Assert

            Assert.Equal(((List<PetroTable>)actualRecord), bAPI.petroTable.Where(s => s.VersionID == versionId).ToList());
        }

        [Fact]
        public async Task GetAllPetroTablesByVersionTest_Fail()
        {

            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            ILoggingFacade fakeLogger = FakeLogger();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);// bAPI;
            var localizer = new MockStringLocalizer<EPSTableController>();
            EPSTableController controller = FakeController(_cache, epsTableApi,localizer);


            //.. Act
            var dinfo = await controller.GetAllPetroTablesByVersion(0);
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo);

            //..Assert
            Assert.Equal((actualRecord).StatusCode, (int)System.Net.HttpStatusCode.InternalServerError);
            Assert.Equal(actualRecord.Value, "Test Localized String");
        }

        [Fact]
        public async Task EPSUpsertPetroTableTest_Success()
        {
            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();
            ILoggingFacade fakeLogger = FakeLogger();
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);
            var localizer = new MockStringLocalizer<EPSTableController>();
            EPSTableController controller = FakeController(_cache, epsTableApi,localizer);

            PetroTable petroTable = new PetroTable();
            petroTable.TableID = 2;
            petroTable.TableName = "EPSGeneralParametersTable";
            petroTable.VersionID = 1;
            petroTable.Active = true;
            petroTable.DefinitionOnly = false;
            petroTable.SchemaDef = "<!-- edited with XMLSpy v2008 (http://www.altova.com) by Bradford Loewy (VERIFONE) --><!-- edited with XMLSPY v2004 rel. 3 U (http://www.xmlspy.com) by Clerley Silveira (VeriFone, Inc.) --><xs:schema xmlns:tt='http://www.verifone.com/eps/viper/namespace/Dictionary/v1' xmlns:xs='http://www.w3.org/2001/XMLSchema' xmlns='http://www.verifone.com/eps/viper/namespace/v1' targetNamespace='http://www.verifone.com/eps/viper/namespace/v1' elementFormDefault='qualified' attributeFormDefault='unqualified'><xs:import namespace='http://www.verifone.com/eps/viper/namespace/Dictionary/v1' schemaLocation='Dictionary.xsd' /><xs:element name='EPSGeneralParameters'><xs:annotation><xs:documentation>EPS General Parameters Table</xs:documentation></xs:annotation><xs:complexType><xs:sequence><xs:element name='SiteName' type='xs:string'><xs:annotation><xs:documentation>Name of the store location (i.e. Bradford’s Convenience Store)</xs:documentation></xs:annotation></xs:element><xs:element name='SiteID' type='xs:string'><xs:annotation><xs:documentation>Site ID as known from the system providing the EPS tables. (may be used on receipts, reports, asset page)</xs:documentation></xs:annotation></xs:element><xs:element name='SiteTimeSyncControl'><xs:annotation><xs:documentation>Determines is POS or FEP controls EPS time.  “POS”: EPS Time is controlled by the POS.  If the time is to be controlled by a FEP, this should be the FEPName corresponding to that field in the FEPTable.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:string' /></xs:simpleType></xs:element><xs:element name='SitePrimaryCurrencyCode' type='xs:string'><xs:annotation><xs:documentation>Site Primary Currency Code (used by the FEP)</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternativeCurrencyCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Secondary Currency Code (used by the FEP)</xs:documentation></xs:annotation></xs:element><xs:element name='SitePrimaryISOCurrencyCode' type='xs:string'><xs:annotation><xs:documentation>Site Primary Currency Code - ISO 4217 format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternativeISOCurrencyCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Secondary Currency Code - ISO 4217 format</xs:documentation></xs:annotation></xs:element><xs:element name='SitePrimaryLanguageCode' type='xs:string'><xs:annotation><xs:documentation>Site Primary Language Code - ISO 639 format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternative1LanguageCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Alternative 1 Language Code - ISO 639  format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternative2LanguageCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Alternative 2 Language Code - ISO 639  format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteSendPOSAdminMessages' type='xs:boolean'><xs:annotation><xs:documentation>Flag to control the forwarding to the host of POS Admin Messages.  Setting this flag to false will prevent the forwarding to he FEP of any POS admin messages the EPS receives.</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin1Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin1 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin2Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin2 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin3Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin3 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin4Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin4 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='SiteSendEPSAdminMessages' type='xs:boolean'><xs:annotation><xs:documentation>Flag to control the forwarding to the host of EPSAdmin Messages.  Setting this flag to false will prevent the forwarding to he FEP of all EPS admin messages.</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin1Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin1 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin2Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin2 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin3Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin3 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin4Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin4 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='ConfigMessage' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference store defined declined message when the feature is enabled</xs:documentation></xs:annotation></xs:element><xs:element name='NetworkLastRequired' type='xs:boolean'><xs:annotation><xs:documentation>True - The site does not support split tender or requires that the network transaction is last ; False - The site supports split tender of network transactions</xs:documentation></xs:annotation></xs:element><xs:element name='CashBackPrompt' type='xs:boolean'><xs:annotation><xs:documentation>True - The site may prompt for cash back on cards that permit cash back ; False - The site is not allowed to prompt for cash back, regardless of the flag on the individual card</xs:documentation></xs:annotation></xs:element><xs:element name='DualCardProcessingCode'><xs:annotation><xs:documentation>Controls how cards that can be processed as either credit or debit are handled</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:string'><xs:enumeration value='ForceDebit'><xs:annotation><xs:documentation>MOP Type will be forced to Debit</xs:documentation></xs:annotation></xs:enumeration><xs:enumeration value='ForceCredit'><xs:annotation><xs:documentation>MOP Type will be forced to Credit</xs:documentation></xs:annotation></xs:enumeration><xs:enumeration value='CustomerSelect'><xs:annotation><xs:documentation>Customer will be prompted for MOP Type</xs:documentation></xs:annotation></xs:enumeration><xs:enumeration value='POSSelect'><xs:annotation><xs:documentation>Cashier will be prompted for MOP Type</xs:documentation></xs:annotation></xs:enumeration></xs:restriction></xs:simpleType></xs:element><xs:element name='OverallStoreAndForward'><xs:annotation><xs:documentation>Maximum number of transactions allowed in the EPS Store and Forward</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='0' /><xs:maxInclusive value='9999' /></xs:restriction></xs:simpleType></xs:element><xs:element name='NumberDaysDataStored'><xs:annotation><xs:documentation>Number of days to worth of data the EPS will store</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='1' /><xs:maxInclusive value='30' /></xs:restriction></xs:simpleType></xs:element><xs:element name='PayPointBatchDayCloseTime'><xs:annotation><xs:documentation>Time of day for PayPoint Batch Close.  HH:MM in 24hr time.  Seconds are defautled to 0.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:string'><xs:pattern value='([0-1][0-9]|2[0-3]):[0-5][0-9]' /></xs:restriction></xs:simpleType></xs:element><xs:element name='SecurityDayCount'><xs:annotation><xs:documentation>Amount of days after which certain steps will be followed to maximize security.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='1' /></xs:restriction></xs:simpleType></xs:element><xs:element name='ReportMaskingFlag' type='xs:boolean'><xs:annotation><xs:documentation>True - The site to mask account number on acquirer batch report; False - The site to unmask account number on acquirer batch report</xs:documentation></xs:annotation></xs:element><xs:element name='LoyaltyReportMaskingFlag' type='xs:boolean' minOccurs='0'><xs:annotation><xs:documentation>True - The site to mask account number on Loyalty report; False - The site to unmask account number on Loyalty report</xs:documentation></xs:annotation></xs:element><xs:element name='ClearVelocityHoursCount' type='xs:integer' minOccurs='0'><xs:annotation><xs:documentation>The number of hours velocity will wait before clearing any entry</xs:documentation></xs:annotation></xs:element><xs:element name='OnLineVelocityCheck' type='xs:boolean' minOccurs='0'><xs:annotation><xs:documentation>If enabled velocity will be checked for online transaction as well as offline transactions</xs:documentation></xs:annotation></xs:element><xs:element name='SignatureCaptureEnabled' type='xs:boolean' minOccurs='0' /><xs:element name='DisplaySignatureToCashier' type='xs:boolean' minOccurs='0' /><xs:element name='PrintSignatureOnReceipt' type='xs:boolean' minOccurs='0' /><xs:element name='OutsideCashierMessageSupported' type='xs:boolean' minOccurs='0'><xs:annotation><xs:documentation>True - Allow prompts with TargetUserType=POS to be sent during outside transactions for display to the cashier (e.g. help icon message); False - Prevent prompt with TargetUserType=POS from being sent during outdoor transaction.  POS/DCR subsystem to rely on POS generated default message instead</xs:documentation></xs:annotation></xs:element><xs:element name='CashbackFeeIndicator' type='tt:FeeIndicatorType' minOccurs='0'><xs:annotation><xs:documentation>Points to the cashback fee indicator in the FeeTable or 0 if none</xs:documentation></xs:annotation></xs:element><xs:element name='EBTCashbackFeeIndicator' type='tt:FeeIndicatorType' minOccurs='0'><xs:annotation><xs:documentation>Points to the cashback fee indicator in the FeeTable or 0 if none</xs:documentation></xs:annotation></xs:element><xs:element name='DisallowKioskEPSSplitTender' type='xs:boolean' default='false' minOccurs='0' /><xs:element name='TerminalBatchLimit' minOccurs='0'><xs:annotation><xs:documentation>Maximum terminal batches allowed</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='1' /><xs:maxInclusive value='99999' /></xs:restriction></xs:simpleType></xs:element><xs:element name='DisplayPINpadPromptsToCashier' type='xs:boolean' default='false' minOccurs='0'><xs:annotation><xs:documentation>Gives visibility to cashier on input prompts displayed on PINpad</xs:documentation></xs:annotation></xs:element><xs:element name='UseStoreError' type='xs:boolean' default='false' minOccurs='0'><xs:annotation><xs:documentation>Enables the Cashier to define a message to be displayed on the DCR</xs:documentation></xs:annotation></xs:element></xs:sequence><xs:attribute name='version' type='tt:VersionType' use='required' /></xs:complexType></xs:element></xs:schema>";
            petroTable.DefaultXML = "<!-- edited with XMLSPY v2004 rel. 3 U (http://www.xmlspy.com) by Bradford Loewy (VeriFone, Inc.) --><EPSGeneralParameters xmlns='http://www.verifone.com/eps/viper/namespace/v1' xmlns:tt='http://www.verifone.com/eps/viper/namespace/Dictionary/v1' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' version='0' xsi:schemaLocation='http://www.verifone.com/eps/viper/namespace/v1 ../schemas/tables/EPSGeneralParametersTable.xsd'><SiteName>VeriFone Gold Disk</SiteName><SiteID>9999999</SiteID><SiteTimeSyncControl>worldpay</SiteTimeSyncControl><SitePrimaryCurrencyCode>840</SitePrimaryCurrencyCode><SiteAlternativeCurrencyCode /><SitePrimaryISOCurrencyCode>USD</SitePrimaryISOCurrencyCode><SiteAlternativeISOCurrencyCode>USD</SiteAlternativeISOCurrencyCode><SitePrimaryLanguageCode>en</SitePrimaryLanguageCode><SiteAlternative1LanguageCode /><SiteAlternative2LanguageCode /><SiteSendPOSAdminMessages>true</SiteSendPOSAdminMessages><FEPIndicatorForPOSAdmin1Messages>01</FEPIndicatorForPOSAdmin1Messages><FEPIndicatorForPOSAdmin2Messages>01</FEPIndicatorForPOSAdmin2Messages><FEPIndicatorForPOSAdmin3Messages>01</FEPIndicatorForPOSAdmin3Messages><FEPIndicatorForPOSAdmin4Messages /><SiteSendEPSAdminMessages>true</SiteSendEPSAdminMessages><FEPIndicatorForEPSAdmin1Messages>01</FEPIndicatorForEPSAdmin1Messages><FEPIndicatorForEPSAdmin2Messages>01</FEPIndicatorForEPSAdmin2Messages><FEPIndicatorForEPSAdmin3Messages>01</FEPIndicatorForEPSAdmin3Messages><FEPIndicatorForEPSAdmin4Messages>01</FEPIndicatorForEPSAdmin4Messages><NetworkLastRequired>false</NetworkLastRequired><CashBackPrompt>true</CashBackPrompt><DualCardProcessingCode>CustomerSelect</DualCardProcessingCode><OverallStoreAndForward>500</OverallStoreAndForward><NumberDaysDataStored>15</NumberDaysDataStored><PayPointBatchDayCloseTime>00:00</PayPointBatchDayCloseTime><SecurityDayCount>2</SecurityDayCount><ReportMaskingFlag>false</ReportMaskingFlag><ClearVelocityHoursCount>01</ClearVelocityHoursCount><OnLineVelocityCheck>true</OnLineVelocityCheck><SignatureCaptureEnabled>true</SignatureCaptureEnabled><DisplaySignatureToCashier>true</DisplaySignatureToCashier><PrintSignatureOnReceipt>true</PrintSignatureOnReceipt><OutsideCashierMessageSupported>true</OutsideCashierMessageSupported><CashbackFeeIndicator>1</CashbackFeeIndicator></EPSGeneralParameters>";
            petroTable.CreatedDate = DateTime.Parse("2017-07-25 13:16:18.25");
            petroTable.EffectiveDate = DateTime.Parse("2017-07-25 00:00:00");
            petroTable.LastUpdatedBy = "PNandyala";

            //.. Act
            var dinfo = await controller.EPSUpsertPetroTable(petroTable);
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo).Value;
            var activity = bAPI.petroTable.ToList().Where(s => s.TableName == "EPSGeneralParametersTable" && s.VersionID == 1).FirstOrDefault();

            //..Assert
            Assert.Equal(((bool)actualRecord), true);
            Assert.Equal(petroTable, activity);
        }

        [Fact]
        public async Task EPSUpsertPetroTableTest_SuccessWithDefnitionOnly()
        {

            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();
            ILoggingFacade fakeLogger = FakeLogger();
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);
            var localizer = new MockStringLocalizer<EPSTableController>();
            EPSTableController controller = FakeController(_cache, epsTableApi, localizer);

            PetroTable petroTable = new PetroTable();
            petroTable.TableID = 3;
            petroTable.TableName = "EPSGeneralParametersTable";
            petroTable.VersionID = 1;
            petroTable.Active = false;
            petroTable.DefinitionOnly = true;
            petroTable.SchemaDef = "<!-- edited with XMLSpy v2008 (http://www.altova.com) by Bradford Loewy (VERIFONE) --><!-- edited with XMLSPY v2004 rel. 3 U (http://www.xmlspy.com) by Clerley Silveira (VeriFone, Inc.) --><xs:schema xmlns:tt='http://www.verifone.com/eps/viper/namespace/Dictionary/v1' xmlns:xs='http://www.w3.org/2001/XMLSchema' xmlns='http://www.verifone.com/eps/viper/namespace/v1' targetNamespace='http://www.verifone.com/eps/viper/namespace/v1' elementFormDefault='qualified' attributeFormDefault='unqualified'><xs:import namespace='http://www.verifone.com/eps/viper/namespace/Dictionary/v1' schemaLocation='Dictionary.xsd' /><xs:element name='EPSGeneralParameters'><xs:annotation><xs:documentation>EPS General Parameters Table</xs:documentation></xs:annotation><xs:complexType><xs:sequence><xs:element name='SiteName' type='xs:string'><xs:annotation><xs:documentation>Name of the store location (i.e. Bradford’s Convenience Store)</xs:documentation></xs:annotation></xs:element><xs:element name='SiteID' type='xs:string'><xs:annotation><xs:documentation>Site ID as known from the system providing the EPS tables. (may be used on receipts, reports, asset page)</xs:documentation></xs:annotation></xs:element><xs:element name='SiteTimeSyncControl'><xs:annotation><xs:documentation>Determines is POS or FEP controls EPS time.  “POS”: EPS Time is controlled by the POS.  If the time is to be controlled by a FEP, this should be the FEPName corresponding to that field in the FEPTable.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:string' /></xs:simpleType></xs:element><xs:element name='SitePrimaryCurrencyCode' type='xs:string'><xs:annotation><xs:documentation>Site Primary Currency Code (used by the FEP)</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternativeCurrencyCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Secondary Currency Code (used by the FEP)</xs:documentation></xs:annotation></xs:element><xs:element name='SitePrimaryISOCurrencyCode' type='xs:string'><xs:annotation><xs:documentation>Site Primary Currency Code - ISO 4217 format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternativeISOCurrencyCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Secondary Currency Code - ISO 4217 format</xs:documentation></xs:annotation></xs:element><xs:element name='SitePrimaryLanguageCode' type='xs:string'><xs:annotation><xs:documentation>Site Primary Language Code - ISO 639 format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternative1LanguageCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Alternative 1 Language Code - ISO 639  format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteAlternative2LanguageCode' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Site Alternative 2 Language Code - ISO 639  format</xs:documentation></xs:annotation></xs:element><xs:element name='SiteSendPOSAdminMessages' type='xs:boolean'><xs:annotation><xs:documentation>Flag to control the forwarding to the host of POS Admin Messages.  Setting this flag to false will prevent the forwarding to he FEP of any POS admin messages the EPS receives.</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin1Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin1 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin2Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin2 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin3Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin3 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForPOSAdmin4Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP POSAdmin4 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='SiteSendEPSAdminMessages' type='xs:boolean'><xs:annotation><xs:documentation>Flag to control the forwarding to the host of EPSAdmin Messages.  Setting this flag to false will prevent the forwarding to he FEP of all EPS admin messages.</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin1Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin1 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin2Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin2 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin3Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin3 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='FEPIndicatorForEPSAdmin4Messages' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference into the FEPIndicatorTable to override to which FEP EPSAdmin4 Messages are sent</xs:documentation></xs:annotation></xs:element><xs:element name='ConfigMessage' type='xs:string' minOccurs='0'><xs:annotation><xs:documentation>Reference store defined declined message when the feature is enabled</xs:documentation></xs:annotation></xs:element><xs:element name='NetworkLastRequired' type='xs:boolean'><xs:annotation><xs:documentation>True - The site does not support split tender or requires that the network transaction is last ; False - The site supports split tender of network transactions</xs:documentation></xs:annotation></xs:element><xs:element name='CashBackPrompt' type='xs:boolean'><xs:annotation><xs:documentation>True - The site may prompt for cash back on cards that permit cash back ; False - The site is not allowed to prompt for cash back, regardless of the flag on the individual card</xs:documentation></xs:annotation></xs:element><xs:element name='DualCardProcessingCode'><xs:annotation><xs:documentation>Controls how cards that can be processed as either credit or debit are handled</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:string'><xs:enumeration value='ForceDebit'><xs:annotation><xs:documentation>MOP Type will be forced to Debit</xs:documentation></xs:annotation></xs:enumeration><xs:enumeration value='ForceCredit'><xs:annotation><xs:documentation>MOP Type will be forced to Credit</xs:documentation></xs:annotation></xs:enumeration><xs:enumeration value='CustomerSelect'><xs:annotation><xs:documentation>Customer will be prompted for MOP Type</xs:documentation></xs:annotation></xs:enumeration><xs:enumeration value='POSSelect'><xs:annotation><xs:documentation>Cashier will be prompted for MOP Type</xs:documentation></xs:annotation></xs:enumeration></xs:restriction></xs:simpleType></xs:element><xs:element name='OverallStoreAndForward'><xs:annotation><xs:documentation>Maximum number of transactions allowed in the EPS Store and Forward</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='0' /><xs:maxInclusive value='9999' /></xs:restriction></xs:simpleType></xs:element><xs:element name='NumberDaysDataStored'><xs:annotation><xs:documentation>Number of days to worth of data the EPS will store</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='1' /><xs:maxInclusive value='30' /></xs:restriction></xs:simpleType></xs:element><xs:element name='PayPointBatchDayCloseTime'><xs:annotation><xs:documentation>Time of day for PayPoint Batch Close.  HH:MM in 24hr time.  Seconds are defautled to 0.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:string'><xs:pattern value='([0-1][0-9]|2[0-3]):[0-5][0-9]' /></xs:restriction></xs:simpleType></xs:element><xs:element name='SecurityDayCount'><xs:annotation><xs:documentation>Amount of days after which certain steps will be followed to maximize security.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='1' /></xs:restriction></xs:simpleType></xs:element><xs:element name='ReportMaskingFlag' type='xs:boolean'><xs:annotation><xs:documentation>True - The site to mask account number on acquirer batch report; False - The site to unmask account number on acquirer batch report</xs:documentation></xs:annotation></xs:element><xs:element name='LoyaltyReportMaskingFlag' type='xs:boolean' minOccurs='0'><xs:annotation><xs:documentation>True - The site to mask account number on Loyalty report; False - The site to unmask account number on Loyalty report</xs:documentation></xs:annotation></xs:element><xs:element name='ClearVelocityHoursCount' type='xs:integer' minOccurs='0'><xs:annotation><xs:documentation>The number of hours velocity will wait before clearing any entry</xs:documentation></xs:annotation></xs:element><xs:element name='OnLineVelocityCheck' type='xs:boolean' minOccurs='0'><xs:annotation><xs:documentation>If enabled velocity will be checked for online transaction as well as offline transactions</xs:documentation></xs:annotation></xs:element><xs:element name='SignatureCaptureEnabled' type='xs:boolean' minOccurs='0' /><xs:element name='DisplaySignatureToCashier' type='xs:boolean' minOccurs='0' /><xs:element name='PrintSignatureOnReceipt' type='xs:boolean' minOccurs='0' /><xs:element name='OutsideCashierMessageSupported' type='xs:boolean' minOccurs='0'><xs:annotation><xs:documentation>True - Allow prompts with TargetUserType=POS to be sent during outside transactions for display to the cashier (e.g. help icon message); False - Prevent prompt with TargetUserType=POS from being sent during outdoor transaction.  POS/DCR subsystem to rely on POS generated default message instead</xs:documentation></xs:annotation></xs:element><xs:element name='CashbackFeeIndicator' type='tt:FeeIndicatorType' minOccurs='0'><xs:annotation><xs:documentation>Points to the cashback fee indicator in the FeeTable or 0 if none</xs:documentation></xs:annotation></xs:element><xs:element name='EBTCashbackFeeIndicator' type='tt:FeeIndicatorType' minOccurs='0'><xs:annotation><xs:documentation>Points to the cashback fee indicator in the FeeTable or 0 if none</xs:documentation></xs:annotation></xs:element><xs:element name='DisallowKioskEPSSplitTender' type='xs:boolean' default='false' minOccurs='0' /><xs:element name='TerminalBatchLimit' minOccurs='0'><xs:annotation><xs:documentation>Maximum terminal batches allowed</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base='xs:integer'><xs:minInclusive value='1' /><xs:maxInclusive value='99999' /></xs:restriction></xs:simpleType></xs:element><xs:element name='DisplayPINpadPromptsToCashier' type='xs:boolean' default='false' minOccurs='0'><xs:annotation><xs:documentation>Gives visibility to cashier on input prompts displayed on PINpad</xs:documentation></xs:annotation></xs:element><xs:element name='UseStoreError' type='xs:boolean' default='false' minOccurs='0'><xs:annotation><xs:documentation>Enables the Cashier to define a message to be displayed on the DCR</xs:documentation></xs:annotation></xs:element></xs:sequence><xs:attribute name='version' type='tt:VersionType' use='required' /></xs:complexType></xs:element></xs:schema>";
            petroTable.CreatedDate = DateTime.Parse("2017-07-25 13:16:18.25");
            petroTable.EffectiveDate = DateTime.Parse("2017-07-25 00:00:00");
            petroTable.LastUpdatedBy = "Test";

            //.. Act
            var dinfo = await controller.EPSUpsertPetroTable(petroTable);
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo).Value;
            var activity = bAPI.petroTable.ToList().Where(s => s.TableName == "EPSGeneralParametersTable" && s.VersionID == 1).FirstOrDefault();

            //..Assert
            Assert.Equal(((bool)actualRecord), true);
            Assert.Equal(petroTable, activity);
        }
        [Fact]
        public async Task EPSUpsertPetroTableTest_Fail()
        {

            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();
            ILoggingFacade fakeLogger = FakeLogger();
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);
            var localizer = new MockStringLocalizer<EPSTableController>();
            localizer[0] = new LocalizedString("EPSTableDefaultXMLErrorMsg", "DefaultXML provided when Definitiononly checked");
            EPSTableController controller = FakeController(_cache, epsTableApi, localizer);

            PetroTable petroTable = new PetroTable();
            petroTable.TableID = 1;
            petroTable.TableName = null;
            petroTable.VersionID = 1;
            petroTable.Active = false;
            petroTable.DefinitionOnly = true;
            petroTable.SchemaDef = "<!-- edited with XMLSpy v2014 (http://www.altova.com) by Farhan (Verifone Inc.) --><xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:this=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" targetNamespace=\"http://www.verifone.com/eps/viper/namespace/v1\" elementFormDefault=\"qualified\" attributeFormDefault=\"unqualified\"><xs:import namespace=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" schemaLocation=\"Dictionary.xsd\" /><xs:element name=\"AIDTable\"><xs:complexType><xs:sequence><xs:element name=\"AIDRow\" type=\"this:AIDRowType\" minOccurs=\"0\" maxOccurs=\"unbounded\" /></xs:sequence><xs:attribute name=\"version\" type=\"tt:VersionType\" use=\"required\" /></xs:complexType><xs:key name=\"AIDPK\"><xs:selector xpath=\"this:AIDRow\" /><xs:field xpath=\"this:AID\" /></xs:key></xs:element><xs:complexType name=\"AIDRowType\"><xs:sequence><xs:element name=\"AID\" type=\"tt:AIDType\"><xs:annotation><xs:documentation>Uniquely identifies the application (RID + PIX)</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDName\"><xs:annotation><xs:documentation>AID name used for cardholder confirmation if not present in card </xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"RIDName\" minOccurs=\"0\"><xs:annotation><xs:documentation>Card scheme label. E.g. VISA, Mastercard, etc.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"35\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"AIDEnabled\" type=\"xs:boolean\"><xs:annotation><xs:documentation>Indicates whether the AID is allowed or not</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDMode\" type=\"tt:ModeTypes\"><xs:annotation><xs:documentation>Defines whether it is a Contact or Contactless AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagList\" type=\"TagListType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Additional list of transaction tags required to be send to the host for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagListExclude\" type=\"TagListType\" minOccurs=\"0\" maxOccurs=\"1\"><xs:annotation><xs:documentation>Defines list of required that should not be used for the corresponding AID in the transaction</xs:documentation></xs:annotation></xs:element><xs:element name=\"PinBypassFlag\" type=\"tt:PinBypassType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TransactionType\" type=\"tt:UsageFlag\" minOccurs=\"0\" maxOccurs=\"unbounded\"><xs:annotation><xs:documentation>Indicates the transaction types associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalApplicationVersionNumber1\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalApplicationVersionNumber2\" minOccurs=\"0\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalRiskManagementData\" minOccurs=\"0\"><xs:annotation><xs:documentation>Application specific value used by the card for risk management purposes</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"2\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalCapabilities\"><xs:annotation><xs:documentation>Indicates the card data input, CVM, and security capabilities of the terminal</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"6\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"ApplicationCountryCode\" type=\"tt:StringIndexThreeType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates the Country Code associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalFloorLimit\" type=\"tt:DigitIndexEightType\"><xs:annotation><xs:documentation>Indicates the floor limit in the terminal in conjunction with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"RandomSelectionThreshold\" type=\"tt:DigitIndexEightType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Value used in terminal risk management for random transaction selection. Must be zero or a positive number less than the floor limit</xs:documentation></xs:annotation></xs:element><xs:element name=\"TargetRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the threshold value that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"MaxRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the floor limit that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"TACDefault\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be rejected if it might have been approved online, but the terminal is unable to process the transaction online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACDenial\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause the denial of a transaction without attempt to go online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACOnline\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be transmitted online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TDOLDefault\" type=\"xs:string\"><xs:annotation><xs:documentation>TDOL to be used for generating the TC Hash Value if the TDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"DDOLDefault\" type=\"xs:string\" minOccurs=\"0\"><xs:annotation><xs:documentation>DDOL to be used for constructing the INTERNAL AUTHENTICATE command if the DDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"StandinTVRMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TVR Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"StandinTSIMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TSI Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"PinBypassAmount\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than or equal to this amount, PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AllowEMVStandInOnOfflineDecline\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether EMV Stand-In processing is allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"CheckCountryCodeForEMVStandIn\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether the Country Code should be checked during EMV Stand-In processing for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"EMVStandInFloorLimit\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than this value, then the transaction would be applicable for EMV Stand-In processing</xs:documentation></xs:annotation></xs:element></xs:sequence></xs:complexType><xs:simpleType name=\"TagListType\"><xs:annotation><xs:documentation>\r\n\t\t\t\tRepresents a list of EMV tag types. Each list is a hexadecimal representation of TLV type. An tag entry is either of 2 or 4 characters of length and no more than 255 entries are allowed\r\n\t\t\t</xs:documentation></xs:annotation><xs:restriction base=\"xs:string\"><xs:maxLength value=\"1020\" /><xs:pattern value=\"([a-fA-F0-9])*\" /></xs:restriction></xs:simpleType></xs:schema>";
            petroTable.DefaultXML = "<AIDTable xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" version=\"1\" xsi:schemaLocation=\"http://www.verifone.com/eps/viper/namespace/v1 ../schemas/tables/AIDTable.xsd\"><AIDRow><AID>A0000000031010</AID><AIDName>VISA CREDIT</AIDName><RIDName>VISA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>008C</TerminalApplicationVersionNumber1><TerminalRiskManagementData>A444A</TerminalRiskManagementData><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000032010</AID><AIDName>Visa Electron</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000033010</AID><AIDName>Visa Interlink</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000041010</AID><AIDName>MC CREDIT</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000043060</AID><AIDName>MC Credit</AIDName><RIDName>MasterCard</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001523010</AID><AIDName>DISCOVER CREDIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A00000002501</AID><AIDName>AMEX CREDIT</AIDName><RIDName>AMEX</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC00002000</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>FCE09CF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000980840</AID><AIDName>Common Debit</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001524010</AID><AIDName>DISCOVER DEBIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000042203</AID><AIDName>MASTERCARD Debit</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000006200620</AID><AIDName>Common Debit</AIDName><RIDName>DNA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50ACA000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow></AIDTable>";
            petroTable.CreatedDate = DateTime.Parse("2017-07-25 13:16:18.25");
            petroTable.EffectiveDate = DateTime.Parse("2017-07-25 00:00:00");
            petroTable.LastUpdatedBy = "Test";

            //.. Act
            var dinfo = await controller.EPSUpsertPetroTable(petroTable);
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo);

            //..Assert
            Assert.Equal(actualRecord.StatusCode, (int)System.Net.HttpStatusCode.BadRequest);
            Assert.Equal(actualRecord.Value, "DefaultXML provided when Definitiononly checked");
        }


        [Fact]
        public async Task EPSUpsertPetroTableTest_FailEffectiveDateNotProvided()
        {

            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();
            ILoggingFacade fakeLogger = FakeLogger();
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);
            var localizer = new MockStringLocalizer<EPSTableController>();
            localizer[0] = new LocalizedString("EPSTableEffectiveDateErrorMsg", "EffectiveDate not provided");
            EPSTableController controller = FakeController(_cache, epsTableApi, localizer);

            PetroTable petroTable = new PetroTable();
            petroTable.TableID = 1;
            petroTable.TableName = null;
            petroTable.VersionID = 1;
            petroTable.Active = false;
            petroTable.DefinitionOnly = false;
            petroTable.SchemaDef = "<!-- edited with XMLSpy v2014 (http://www.altova.com) by Farhan (Verifone Inc.) --><xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:this=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" targetNamespace=\"http://www.verifone.com/eps/viper/namespace/v1\" elementFormDefault=\"qualified\" attributeFormDefault=\"unqualified\"><xs:import namespace=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" schemaLocation=\"Dictionary.xsd\" /><xs:element name=\"AIDTable\"><xs:complexType><xs:sequence><xs:element name=\"AIDRow\" type=\"this:AIDRowType\" minOccurs=\"0\" maxOccurs=\"unbounded\" /></xs:sequence><xs:attribute name=\"version\" type=\"tt:VersionType\" use=\"required\" /></xs:complexType><xs:key name=\"AIDPK\"><xs:selector xpath=\"this:AIDRow\" /><xs:field xpath=\"this:AID\" /></xs:key></xs:element><xs:complexType name=\"AIDRowType\"><xs:sequence><xs:element name=\"AID\" type=\"tt:AIDType\"><xs:annotation><xs:documentation>Uniquely identifies the application (RID + PIX)</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDName\"><xs:annotation><xs:documentation>AID name used for cardholder confirmation if not present in card </xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"RIDName\" minOccurs=\"0\"><xs:annotation><xs:documentation>Card scheme label. E.g. VISA, Mastercard, etc.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"35\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"AIDEnabled\" type=\"xs:boolean\"><xs:annotation><xs:documentation>Indicates whether the AID is allowed or not</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDMode\" type=\"tt:ModeTypes\"><xs:annotation><xs:documentation>Defines whether it is a Contact or Contactless AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagList\" type=\"TagListType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Additional list of transaction tags required to be send to the host for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagListExclude\" type=\"TagListType\" minOccurs=\"0\" maxOccurs=\"1\"><xs:annotation><xs:documentation>Defines list of required that should not be used for the corresponding AID in the transaction</xs:documentation></xs:annotation></xs:element><xs:element name=\"PinBypassFlag\" type=\"tt:PinBypassType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TransactionType\" type=\"tt:UsageFlag\" minOccurs=\"0\" maxOccurs=\"unbounded\"><xs:annotation><xs:documentation>Indicates the transaction types associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalApplicationVersionNumber1\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalApplicationVersionNumber2\" minOccurs=\"0\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalRiskManagementData\" minOccurs=\"0\"><xs:annotation><xs:documentation>Application specific value used by the card for risk management purposes</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"2\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalCapabilities\"><xs:annotation><xs:documentation>Indicates the card data input, CVM, and security capabilities of the terminal</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"6\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"ApplicationCountryCode\" type=\"tt:StringIndexThreeType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates the Country Code associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalFloorLimit\" type=\"tt:DigitIndexEightType\"><xs:annotation><xs:documentation>Indicates the floor limit in the terminal in conjunction with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"RandomSelectionThreshold\" type=\"tt:DigitIndexEightType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Value used in terminal risk management for random transaction selection. Must be zero or a positive number less than the floor limit</xs:documentation></xs:annotation></xs:element><xs:element name=\"TargetRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the threshold value that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"MaxRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the floor limit that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"TACDefault\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be rejected if it might have been approved online, but the terminal is unable to process the transaction online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACDenial\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause the denial of a transaction without attempt to go online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACOnline\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be transmitted online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TDOLDefault\" type=\"xs:string\"><xs:annotation><xs:documentation>TDOL to be used for generating the TC Hash Value if the TDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"DDOLDefault\" type=\"xs:string\" minOccurs=\"0\"><xs:annotation><xs:documentation>DDOL to be used for constructing the INTERNAL AUTHENTICATE command if the DDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"StandinTVRMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TVR Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"StandinTSIMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TSI Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"PinBypassAmount\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than or equal to this amount, PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AllowEMVStandInOnOfflineDecline\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether EMV Stand-In processing is allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"CheckCountryCodeForEMVStandIn\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether the Country Code should be checked during EMV Stand-In processing for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"EMVStandInFloorLimit\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than this value, then the transaction would be applicable for EMV Stand-In processing</xs:documentation></xs:annotation></xs:element></xs:sequence></xs:complexType><xs:simpleType name=\"TagListType\"><xs:annotation><xs:documentation>\r\n\t\t\t\tRepresents a list of EMV tag types. Each list is a hexadecimal representation of TLV type. An tag entry is either of 2 or 4 characters of length and no more than 255 entries are allowed\r\n\t\t\t</xs:documentation></xs:annotation><xs:restriction base=\"xs:string\"><xs:maxLength value=\"1020\" /><xs:pattern value=\"([a-fA-F0-9])*\" /></xs:restriction></xs:simpleType></xs:schema>";
            petroTable.DefaultXML = "<AIDTable xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" version=\"1\" xsi:schemaLocation=\"http://www.verifone.com/eps/viper/namespace/v1 ../schemas/tables/AIDTable.xsd\"><AIDRow><AID>A0000000031010</AID><AIDName>VISA CREDIT</AIDName><RIDName>VISA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>008C</TerminalApplicationVersionNumber1><TerminalRiskManagementData>A444A</TerminalRiskManagementData><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000032010</AID><AIDName>Visa Electron</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000033010</AID><AIDName>Visa Interlink</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000041010</AID><AIDName>MC CREDIT</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000043060</AID><AIDName>MC Credit</AIDName><RIDName>MasterCard</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001523010</AID><AIDName>DISCOVER CREDIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A00000002501</AID><AIDName>AMEX CREDIT</AIDName><RIDName>AMEX</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC00002000</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>FCE09CF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000980840</AID><AIDName>Common Debit</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001524010</AID><AIDName>DISCOVER DEBIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000042203</AID><AIDName>MASTERCARD Debit</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000006200620</AID><AIDName>Common Debit</AIDName><RIDName>DNA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50ACA000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow></AIDTable>";
            petroTable.CreatedDate = DateTime.Parse("2017-07-25 13:16:18.25");
            petroTable.LastUpdatedBy = "Test";

            //.. Act
            var dinfo = await controller.EPSUpsertPetroTable(petroTable);
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo);

            //..Assert
            Assert.Equal(actualRecord.StatusCode, (int)System.Net.HttpStatusCode.BadRequest);
            Assert.Equal(actualRecord.Value, "EffectiveDate not provided");
        }

        [Fact]
        public async Task EPSUpsertPetroTableTest_FailLastUpdatedByNotProvided()
        {

            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();
            ILoggingFacade fakeLogger = FakeLogger();
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);// bAPI;
            var localizer = new MockStringLocalizer<EPSTableController>();
            localizer[0] = new LocalizedString("EPSTableLastUpdatedByErrorMsg", "LastUpdatedBy not provided");
            EPSTableController controller = FakeController(_cache, epsTableApi, localizer);

            PetroTable petroTable = new PetroTable();
            petroTable.TableID = 1;
            petroTable.TableName = null;
            petroTable.VersionID = 1;
            petroTable.Active = false;
            petroTable.DefinitionOnly = false;
            petroTable.SchemaDef = "<!-- edited with XMLSpy v2014 (http://www.altova.com) by Farhan (Verifone Inc.) --><xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:this=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" targetNamespace=\"http://www.verifone.com/eps/viper/namespace/v1\" elementFormDefault=\"qualified\" attributeFormDefault=\"unqualified\"><xs:import namespace=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" schemaLocation=\"Dictionary.xsd\" /><xs:element name=\"AIDTable\"><xs:complexType><xs:sequence><xs:element name=\"AIDRow\" type=\"this:AIDRowType\" minOccurs=\"0\" maxOccurs=\"unbounded\" /></xs:sequence><xs:attribute name=\"version\" type=\"tt:VersionType\" use=\"required\" /></xs:complexType><xs:key name=\"AIDPK\"><xs:selector xpath=\"this:AIDRow\" /><xs:field xpath=\"this:AID\" /></xs:key></xs:element><xs:complexType name=\"AIDRowType\"><xs:sequence><xs:element name=\"AID\" type=\"tt:AIDType\"><xs:annotation><xs:documentation>Uniquely identifies the application (RID + PIX)</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDName\"><xs:annotation><xs:documentation>AID name used for cardholder confirmation if not present in card </xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"RIDName\" minOccurs=\"0\"><xs:annotation><xs:documentation>Card scheme label. E.g. VISA, Mastercard, etc.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"35\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"AIDEnabled\" type=\"xs:boolean\"><xs:annotation><xs:documentation>Indicates whether the AID is allowed or not</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDMode\" type=\"tt:ModeTypes\"><xs:annotation><xs:documentation>Defines whether it is a Contact or Contactless AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagList\" type=\"TagListType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Additional list of transaction tags required to be send to the host for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagListExclude\" type=\"TagListType\" minOccurs=\"0\" maxOccurs=\"1\"><xs:annotation><xs:documentation>Defines list of required that should not be used for the corresponding AID in the transaction</xs:documentation></xs:annotation></xs:element><xs:element name=\"PinBypassFlag\" type=\"tt:PinBypassType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TransactionType\" type=\"tt:UsageFlag\" minOccurs=\"0\" maxOccurs=\"unbounded\"><xs:annotation><xs:documentation>Indicates the transaction types associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalApplicationVersionNumber1\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalApplicationVersionNumber2\" minOccurs=\"0\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalRiskManagementData\" minOccurs=\"0\"><xs:annotation><xs:documentation>Application specific value used by the card for risk management purposes</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"2\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalCapabilities\"><xs:annotation><xs:documentation>Indicates the card data input, CVM, and security capabilities of the terminal</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"6\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"ApplicationCountryCode\" type=\"tt:StringIndexThreeType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates the Country Code associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalFloorLimit\" type=\"tt:DigitIndexEightType\"><xs:annotation><xs:documentation>Indicates the floor limit in the terminal in conjunction with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"RandomSelectionThreshold\" type=\"tt:DigitIndexEightType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Value used in terminal risk management for random transaction selection. Must be zero or a positive number less than the floor limit</xs:documentation></xs:annotation></xs:element><xs:element name=\"TargetRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the threshold value that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"MaxRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the floor limit that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"TACDefault\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be rejected if it might have been approved online, but the terminal is unable to process the transaction online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACDenial\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause the denial of a transaction without attempt to go online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACOnline\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be transmitted online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TDOLDefault\" type=\"xs:string\"><xs:annotation><xs:documentation>TDOL to be used for generating the TC Hash Value if the TDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"DDOLDefault\" type=\"xs:string\" minOccurs=\"0\"><xs:annotation><xs:documentation>DDOL to be used for constructing the INTERNAL AUTHENTICATE command if the DDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"StandinTVRMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TVR Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"StandinTSIMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TSI Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"PinBypassAmount\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than or equal to this amount, PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AllowEMVStandInOnOfflineDecline\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether EMV Stand-In processing is allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"CheckCountryCodeForEMVStandIn\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether the Country Code should be checked during EMV Stand-In processing for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"EMVStandInFloorLimit\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than this value, then the transaction would be applicable for EMV Stand-In processing</xs:documentation></xs:annotation></xs:element></xs:sequence></xs:complexType><xs:simpleType name=\"TagListType\"><xs:annotation><xs:documentation>\r\n\t\t\t\tRepresents a list of EMV tag types. Each list is a hexadecimal representation of TLV type. An tag entry is either of 2 or 4 characters of length and no more than 255 entries are allowed\r\n\t\t\t</xs:documentation></xs:annotation><xs:restriction base=\"xs:string\"><xs:maxLength value=\"1020\" /><xs:pattern value=\"([a-fA-F0-9])*\" /></xs:restriction></xs:simpleType></xs:schema>";
            petroTable.DefaultXML = "<AIDTable xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" version=\"1\" xsi:schemaLocation=\"http://www.verifone.com/eps/viper/namespace/v1 ../schemas/tables/AIDTable.xsd\"><AIDRow><AID>A0000000031010</AID><AIDName>VISA CREDIT</AIDName><RIDName>VISA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>008C</TerminalApplicationVersionNumber1><TerminalRiskManagementData>A444A</TerminalRiskManagementData><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000032010</AID><AIDName>Visa Electron</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000033010</AID><AIDName>Visa Interlink</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000041010</AID><AIDName>MC CREDIT</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000043060</AID><AIDName>MC Credit</AIDName><RIDName>MasterCard</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001523010</AID><AIDName>DISCOVER CREDIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A00000002501</AID><AIDName>AMEX CREDIT</AIDName><RIDName>AMEX</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC00002000</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>FCE09CF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000980840</AID><AIDName>Common Debit</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001524010</AID><AIDName>DISCOVER DEBIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000042203</AID><AIDName>MASTERCARD Debit</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000006200620</AID><AIDName>Common Debit</AIDName><RIDName>DNA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50ACA000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow></AIDTable>";
            petroTable.CreatedDate = DateTime.Parse("2017-07-25 13:16:18.25");
            petroTable.EffectiveDate = DateTime.Parse("2017-07-25 00:00:00");

            //.. Act
            var dinfo = await controller.EPSUpsertPetroTable(petroTable);
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo);

            //..Assert
            Assert.Equal(actualRecord.StatusCode, (int)System.Net.HttpStatusCode.BadRequest);
            Assert.Equal(actualRecord.Value, "LastUpdatedBy not provided");
        }

        [Fact]
        public async Task EPSUpsertPetroTableTest_SuccessUpsert()
        {

            MockEPSTableRepository bAPI = new MockEPSTableRepository();
            IDistributedCache _cache = FakeCache();
            ILoggingFacade fakeLogger = FakeLogger();
            IOptions<Settings> appSettings = Substitute.For<IOptions<Settings>>();          
            IXmlApi xmlApi = new XmlApi(fakeLogger);
            IEPSTableApi epsTableApi = new EPSTableApi(appSettings, bAPI,xmlApi);
            var localizer = new MockStringLocalizer<EPSTableController>();
            EPSTableController controller = FakeController(_cache, epsTableApi,localizer);
            PetroTable petroTable = new PetroTable();
            petroTable.TableID = 2;
            petroTable.TableName = "AIDTable";
            petroTable.VersionID = 1;
            petroTable.Active = true;
            petroTable.DefinitionOnly = false;
            petroTable.SchemaDef = "<!-- edited with XMLSpy v2014 (http://www.altova.com) by Farhan (Verifone Inc.) --><xs:schema xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:this=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" targetNamespace=\"http://www.verifone.com/eps/viper/namespace/v1\" elementFormDefault=\"qualified\" attributeFormDefault=\"unqualified\"><xs:import namespace=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" schemaLocation=\"Dictionary.xsd\" /><xs:element name=\"AIDTable\"><xs:complexType><xs:sequence><xs:element name=\"AIDRow\" type=\"this:AIDRowType\" minOccurs=\"0\" maxOccurs=\"unbounded\" /></xs:sequence><xs:attribute name=\"version\" type=\"tt:VersionType\" use=\"required\" /></xs:complexType><xs:key name=\"AIDPK\"><xs:selector xpath=\"this:AIDRow\" /><xs:field xpath=\"this:AID\" /></xs:key></xs:element><xs:complexType name=\"AIDRowType\"><xs:sequence><xs:element name=\"AID\" type=\"tt:AIDType\"><xs:annotation><xs:documentation>Uniquely identifies the application (RID + PIX)</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDName\"><xs:annotation><xs:documentation>AID name used for cardholder confirmation if not present in card </xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"RIDName\" minOccurs=\"0\"><xs:annotation><xs:documentation>Card scheme label. E.g. VISA, Mastercard, etc.</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"1\" /><xs:maxLength value=\"35\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"AIDEnabled\" type=\"xs:boolean\"><xs:annotation><xs:documentation>Indicates whether the AID is allowed or not</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDMode\" type=\"tt:ModeTypes\"><xs:annotation><xs:documentation>Defines whether it is a Contact or Contactless AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagList\" type=\"TagListType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Additional list of transaction tags required to be send to the host for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AIDTagListExclude\" type=\"TagListType\" minOccurs=\"0\" maxOccurs=\"1\"><xs:annotation><xs:documentation>Defines list of required that should not be used for the corresponding AID in the transaction</xs:documentation></xs:annotation></xs:element><xs:element name=\"PinBypassFlag\" type=\"tt:PinBypassType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TransactionType\" type=\"tt:UsageFlag\" minOccurs=\"0\" maxOccurs=\"unbounded\"><xs:annotation><xs:documentation>Indicates the transaction types associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalApplicationVersionNumber1\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalApplicationVersionNumber2\" minOccurs=\"0\"><xs:annotation><xs:documentation>Version number assigned by the payment system for the application</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalRiskManagementData\" minOccurs=\"0\"><xs:annotation><xs:documentation>Application specific value used by the card for risk management purposes</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:minLength value=\"2\" /><xs:maxLength value=\"16\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TerminalCapabilities\"><xs:annotation><xs:documentation>Indicates the card data input, CVM, and security capabilities of the terminal</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"6\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"ApplicationCountryCode\" type=\"tt:StringIndexThreeType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates the Country Code associated with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"TerminalFloorLimit\" type=\"tt:DigitIndexEightType\"><xs:annotation><xs:documentation>Indicates the floor limit in the terminal in conjunction with the AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"RandomSelectionThreshold\" type=\"tt:DigitIndexEightType\" minOccurs=\"0\"><xs:annotation><xs:documentation>Value used in terminal risk management for random transaction selection. Must be zero or a positive number less than the floor limit</xs:documentation></xs:annotation></xs:element><xs:element name=\"TargetRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the threshold value that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"MaxRandomSelectionPercent\" type=\"tt:DigitIndexTwoType\" minOccurs=\"0\"><xs:annotation><xs:documentation>The desired percentage of transactions just below the floor limit that will be selected for Random Selection</xs:documentation></xs:annotation></xs:element><xs:element name=\"TACDefault\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be rejected if it might have been approved online, but the terminal is unable to process the transaction online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACDenial\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause the denial of a transaction without attempt to go online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TACOnline\"><xs:annotation><xs:documentation>Specifies the acquirer‘s conditions that cause a transaction to be transmitted online</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"TDOLDefault\" type=\"xs:string\"><xs:annotation><xs:documentation>TDOL to be used for generating the TC Hash Value if the TDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"DDOLDefault\" type=\"xs:string\" minOccurs=\"0\"><xs:annotation><xs:documentation>DDOL to be used for constructing the INTERNAL AUTHENTICATE command if the DDOL in the card is not present</xs:documentation></xs:annotation></xs:element><xs:element name=\"StandinTVRMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TVR Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"10\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"StandinTSIMask\" minOccurs=\"0\"><xs:annotation><xs:documentation>TSI Mask used for EMV Stand-In processing</xs:documentation></xs:annotation><xs:simpleType><xs:restriction base=\"xs:string\"><xs:length value=\"4\" /></xs:restriction></xs:simpleType></xs:element><xs:element name=\"PinBypassAmount\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than or equal to this amount, PIN bypass should be allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"AllowEMVStandInOnOfflineDecline\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether EMV Stand-In processing is allowed for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"CheckCountryCodeForEMVStandIn\" type=\"xs:boolean\" default=\"false\" minOccurs=\"0\"><xs:annotation><xs:documentation>Indicates whether the Country Code should be checked during EMV Stand-In processing for this AID</xs:documentation></xs:annotation></xs:element><xs:element name=\"EMVStandInFloorLimit\" type=\"tt:StringIndexFourType\" default=\"0000\" minOccurs=\"0\"><xs:annotation><xs:documentation>If the transaction amount is less than this value, then the transaction would be applicable for EMV Stand-In processing</xs:documentation></xs:annotation></xs:element></xs:sequence></xs:complexType><xs:simpleType name=\"TagListType\"><xs:annotation><xs:documentation>\r\n\t\t\t\tRepresents a list of EMV tag types. Each list is a hexadecimal representation of TLV type. An tag entry is either of 2 or 4 characters of length and no more than 255 entries are allowed\r\n\t\t\t</xs:documentation></xs:annotation><xs:restriction base=\"xs:string\"><xs:maxLength value=\"1020\" /><xs:pattern value=\"([a-fA-F0-9])*\" /></xs:restriction></xs:simpleType></xs:schema>";
            petroTable.DefaultXML = "<AIDTable xmlns=\"http://www.verifone.com/eps/viper/namespace/v1\" xmlns:tt=\"http://www.verifone.com/eps/viper/namespace/Dictionary/v1\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" version=\"1\" xsi:schemaLocation=\"http://www.verifone.com/eps/viper/namespace/v1 ../schemas/tables/AIDTable.xsd\"><AIDRow><AID>A0000000031010</AID><AIDName>VISA CREDIT</AIDName><RIDName>VISA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>008C</TerminalApplicationVersionNumber1><TerminalRiskManagementData>A444A</TerminalRiskManagementData><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000032010</AID><AIDName>Visa Electron</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000033010</AID><AIDName>Visa Interlink</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000041010</AID><AIDName>MC CREDIT</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000043060</AID><AIDName>MC Credit</AIDName><RIDName>MasterCard</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001523010</AID><AIDName>DISCOVER CREDIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A00000002501</AID><AIDName>AMEX CREDIT</AIDName><RIDName>AMEX</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>1</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC00002000</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>FCE09CF800</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000980840</AID><AIDName>Common Debit</AIDName><RIDName>Visa</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>DC4000A800</TACDefault><TACDenial>0010000000</TACDenial><TACOnline>DC4004F800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000001524010</AID><AIDName>DISCOVER DEBIT</AIDName><RIDName>DISCOVER</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0001</TerminalApplicationVersionNumber1><TerminalApplicationVersionNumber2>0001</TerminalApplicationVersionNumber2><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000120</RandomSelectionThreshold><TargetRandomSelectionPercent>30</TargetRandomSelectionPercent><MaxRandomSelectionPercent>40</MaxRandomSelectionPercent><TACDefault>C800000000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>C800000000</TACOnline><TDOLDefault>9F020695055F2A029A039C019F3704</TDOLDefault><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000000042203</AID><AIDName>MASTERCARD Debit</AIDName><RIDName>MASTERCARD</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0002</TerminalApplicationVersionNumber1><TerminalCapabilities>E0F8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50BC2000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow><AIDRow><AID>A0000006200620</AID><AIDName>Common Debit</AIDName><RIDName>DNA</RIDName><AIDEnabled>true</AIDEnabled><AIDMode>Contact</AIDMode><PinBypassFlag>0</PinBypassFlag><TransactionType>0</TransactionType><TransactionType>1</TransactionType><TerminalApplicationVersionNumber1>0096</TerminalApplicationVersionNumber1><TerminalCapabilities>E0B8C8</TerminalCapabilities><TerminalFloorLimit>00000000</TerminalFloorLimit><RandomSelectionThreshold>00000000</RandomSelectionThreshold><TargetRandomSelectionPercent>00</TargetRandomSelectionPercent><MaxRandomSelectionPercent>00</MaxRandomSelectionPercent><TACDefault>FC50ACA000</TACDefault><TACDenial>0000000000</TACDenial><TACOnline>FC50BCF800</TACOnline><TDOLDefault /><DDOLDefault>9F3704</DDOLDefault><StandinTVRMask>FD7FFB270F</StandinTVRMask><StandinTSIMask>E800</StandinTSIMask><AllowEMVStandInOnOfflineDecline>false</AllowEMVStandInOnOfflineDecline><CheckCountryCodeForEMVStandIn>false</CheckCountryCodeForEMVStandIn><EMVStandInFloorLimit>0000</EMVStandInFloorLimit></AIDRow></AIDTable>";
            petroTable.CreatedDate = DateTime.Parse("2017-07-25 13:16:18.25");
            petroTable.EffectiveDate = DateTime.Parse("2017-07-25 00:00:00");
            petroTable.LastUpdatedBy = "PNandyala";
            //.. Act
            var dinfo = await controller.EPSUpsertPetroTable(petroTable);//Insert case
            var actualRecord = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo);

            petroTable.CreatedDate = DateTime.Parse("2017-09-19 13:16:18.25");
            dinfo = await controller.EPSUpsertPetroTable(petroTable);//Upsert
            var result = ((Microsoft.AspNetCore.Mvc.ObjectResult)dinfo).Value;
            var duplicateEntry = bAPI.petroTable.Where(s => s.VersionID == petroTable.VersionID
            && s.TableName == petroTable.TableName && s.EffectiveDate == petroTable.EffectiveDate).FirstOrDefault();

            //..Assert
            Assert.Equal((bool)result, true);
            Assert.Equal(duplicateEntry, petroTable);
        }
        private IDistributedCache FakeCache()
        {
            return Substitute.For<IDistributedCache>();
        }

        private static EPSTableController FakeController(IDistributedCache cache, IEPSTableApi epsTableApi, MockStringLocalizer<EPSTableController> localizer)
        {

            if (localizer == null)
                localizer = new MockStringLocalizer<EPSTableController>();
            IOperation fakeOperation = FakeOperation(cache);
            ILoggingFacade fakeLogger = FakeLogger();

            var controller = new EPSTableController(cache, epsTableApi, localizer, fakeOperation, fakeLogger)
            {
            };
            return controller;
        }

        private static ILoggingFacade FakeLogger()
        {
            return Substitute.For<ILoggingFacade>();
        }

        private static IOperation FakeOperation(IDistributedCache cache)
        {
            IOperation fakeOperation = Substitute.For<Operation>(cache);
            return fakeOperation;
        }

        private static IConfigurationRoot getConfigurationBuilder()
        {
            IConfigurationRoot config = new ConfigurationBuilder()
           .AddJsonFile("appsettings.json")
           .Build();
            return config;
        }

    }
}
